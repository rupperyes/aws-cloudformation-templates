{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "7372bde0-3ec1-4e59-a5ed-d00331f81246": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 660,
          "y": 330
        },
        "z": 3,
        "parent": "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
        "embeds": [],
        "ismemberof": [
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
          "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
          "e9536e71-e732-45b1-bfbe-6de3cb45d38f",
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "522b9b95-ecb1-4be0-b959-7d0d381c3f50",
          "e086d890-4c12-4b25-90f9-3733667e60e3",
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        ],
        "isrelatedto": [
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae": {
        "size": {
          "width": 1410,
          "height": 1530
        },
        "position": {
          "x": 420,
          "y": 60
        },
        "z": 1,
        "embeds": [
          "354957ff-f5db-4adf-9db4-ba410fa526dc",
          "0cc90b59-a6f4-4d06-b1c6-723d939a0310",
          "19ff168f-33d3-4323-ac40-9185a58d4bc1",
          "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
          "740a7995-7171-4aa1-a64a-85ca31e1ebd8",
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        ]
      },
      "f6183885-589c-450f-9fd7-b38c0d73997b": {
        "source": {
          "id": "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        },
        "target": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        },
        "z": 1
      },
      "e38cf079-2b2c-484c-8a23-6bc2c8fe63c3": {
        "source": {
          "id": "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        },
        "target": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        },
        "z": 12
      },
      "9c4d1f2a-99b3-40a1-9597-ff01d4374873": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 720,
          "y": 330
        },
        "z": 3,
        "parent": "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
        "embeds": [],
        "ismemberof": [
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
          "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
          "87ee7a24-1cbc-41f3-b569-992f3d37e5df",
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "2f7eb117-ff94-451e-a866-2962568d5445",
          "e086d890-4c12-4b25-90f9-3733667e60e3",
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328",
          "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        ],
        "isrelatedto": [
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "bbea161c-a3b3-4e38-b121-2b5e3d277e21": {
        "size": {
          "width": 750,
          "height": 570
        },
        "position": {
          "x": 480,
          "y": 240
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": [
          "7372bde0-3ec1-4e59-a5ed-d00331f81246",
          "6b1df302-7694-4e74-8e69-7bde89b35309",
          "9c4d1f2a-99b3-40a1-9597-ff01d4374873"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        ]
      },
      "ec029c1f-ac92-4652-bb91-4bc1be0fb462": {
        "source": {
          "id": "bbea161c-a3b3-4e38-b121-2b5e3d277e21"
        },
        "target": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        },
        "z": 11
      },
      "d63b3fc7-ba9f-4fa7-a5ec-5f9e5b52b50e": {
        "source": {
          "id": "9c4d1f2a-99b3-40a1-9597-ff01d4374873"
        },
        "target": {
          "id": "bbea161c-a3b3-4e38-b121-2b5e3d277e21"
        },
        "z": 12
      },
      "ea239752-8a32-4c6c-b267-7e249946ed6d": {
        "source": {
          "id": "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        },
        "target": {
          "id": "bbea161c-a3b3-4e38-b121-2b5e3d277e21"
        },
        "z": 13
      },
      "6b1df302-7694-4e74-8e69-7bde89b35309": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 810,
          "y": 330
        },
        "z": 3,
        "parent": "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
        "embeds": [],
        "ismemberof": [
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
          "bbea161c-a3b3-4e38-b121-2b5e3d277e21",
          "6bc4af5d-0a21-45e3-ba91-d7bd7507236a",
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "75b2464c-d8ef-48f7-8fe0-6aadd2981a3c",
          "e086d890-4c12-4b25-90f9-3733667e60e3",
          "8efd2344-15c6-42da-ae4b-c5ab04bc6328",
          "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        ],
        "isrelatedto": [
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "f2687dbb-271f-4ad5-bb65-9bca35aeabd0": {
        "size": {
          "width": 330,
          "height": 360
        },
        "position": {
          "x": 900,
          "y": 60
        },
        "z": 1,
        "embeds": [
          "75b2464c-d8ef-48f7-8fe0-6aadd2981a3c",
          "2f7eb117-ff94-451e-a866-2962568d5445",
          "522b9b95-ecb1-4be0-b959-7d0d381c3f50",
          "6bc4af5d-0a21-45e3-ba91-d7bd7507236a",
          "87ee7a24-1cbc-41f3-b569-992f3d37e5df",
          "e9536e71-e732-45b1-bfbe-6de3cb45d38f"
        ]
      },
      "e9536e71-e732-45b1-bfbe-6de3cb45d38f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1140,
          "y": 90
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "87ee7a24-1cbc-41f3-b569-992f3d37e5df": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1080,
          "y": 90
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "6bc4af5d-0a21-45e3-ba91-d7bd7507236a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 990,
          "y": 90
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "861caf17-09ae-46cb-88e9-816abbbf3419": {
        "source": {
          "id": "e9536e71-e732-45b1-bfbe-6de3cb45d38f"
        },
        "target": {
          "id": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        },
        "z": 11
      },
      "a35badf7-dce4-4361-9aac-8247c80096e7": {
        "source": {
          "id": "87ee7a24-1cbc-41f3-b569-992f3d37e5df"
        },
        "target": {
          "id": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        },
        "z": 12
      },
      "9003a6fb-6c60-4fd6-a2d0-0d21849efb42": {
        "source": {
          "id": "6bc4af5d-0a21-45e3-ba91-d7bd7507236a"
        },
        "target": {
          "id": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        },
        "z": 13
      },
      "5a8ea687-e7d5-4e0d-b612-6d1eaedbb20c": {
        "source": {
          "id": "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        },
        "target": {
          "id": "e9536e71-e732-45b1-bfbe-6de3cb45d38f"
        },
        "z": 14
      },
      "e6190e42-0ddd-43b6-b297-a8d60a3c9f4f": {
        "source": {
          "id": "9c4d1f2a-99b3-40a1-9597-ff01d4374873"
        },
        "target": {
          "id": "87ee7a24-1cbc-41f3-b569-992f3d37e5df"
        },
        "z": 15
      },
      "e0f21feb-4a60-4123-a8c2-e1aff1e918e5": {
        "source": {
          "id": "6b1df302-7694-4e74-8e69-7bde89b35309"
        },
        "target": {
          "id": "6bc4af5d-0a21-45e3-ba91-d7bd7507236a"
        },
        "z": 16
      },
      "f87133aa-629a-4e89-91f5-7849278dfb3e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "1b03182d-45fa-4b33-8c10-21729c42bdb8": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1050,
          "y": 360
        },
        "z": 1,
        "embeds": []
      },
      "41de699c-05c9-4dc6-839d-ca1e2866ba63": {
        "source": {
          "id": "1b03182d-45fa-4b33-8c10-21729c42bdb8"
        },
        "target": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        },
        "z": 0
      },
      "0cc90b59-a6f4-4d06-b1c6-723d939a0310": {
        "size": {
          "width": 720,
          "height": 390
        },
        "position": {
          "x": 690,
          "y": 270
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": [
          "e086d890-4c12-4b25-90f9-3733667e60e3"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        ]
      },
      "5f696d2a-ef67-445c-9e9a-e9f2fd78aa00": {
        "source": {
          "id": "0cc90b59-a6f4-4d06-b1c6-723d939a0310"
        },
        "target": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        },
        "z": 4
      },
      "e086d890-4c12-4b25-90f9-3733667e60e3": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1170,
          "y": 420
        },
        "z": 3,
        "parent": "0cc90b59-a6f4-4d06-b1c6-723d939a0310",
        "embeds": [],
        "references": [
          "1b03182d-45fa-4b33-8c10-21729c42bdb8"
        ],
        "dependson": [
          "0cc90b59-a6f4-4d06-b1c6-723d939a0310"
        ]
      },
      "184d166f-a472-40b3-9707-b86e3c76135a": {
        "source": {
          "id": "e086d890-4c12-4b25-90f9-3733667e60e3"
        },
        "target": {
          "id": "0cc90b59-a6f4-4d06-b1c6-723d939a0310"
        },
        "z": 4
      },
      "2d10e566-e32b-475b-8ff0-ad97ba910a0d": {
        "size": {
          "width": 150,
          "height": 150
        },
        "position": {
          "x": 150,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "75b2464c-d8ef-48f7-8fe0-6aadd2981a3c": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 930,
          "y": 120
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "2f7eb117-ff94-451e-a866-2962568d5445": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1050,
          "y": 120
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "522b9b95-ecb1-4be0-b959-7d0d381c3f50": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 930,
          "y": 240
        },
        "z": 2,
        "parent": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0",
        "embeds": [],
        "dependson": [
          "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        ]
      },
      "354957ff-f5db-4adf-9db4-ba410fa526dc": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": 1440,
          "y": 120
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": [
          "689ec45f-eaa7-45b9-b35e-7cf75c018d16"
        ],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        ]
      },
      "689ec45f-eaa7-45b9-b35e-7cf75c018d16": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1470,
          "y": 180
        },
        "z": 3,
        "parent": "354957ff-f5db-4adf-9db4-ba410fa526dc",
        "embeds": [],
        "references": [
          "1b03182d-45fa-4b33-8c10-21729c42bdb8"
        ],
        "dependson": [
          "354957ff-f5db-4adf-9db4-ba410fa526dc"
        ]
      },
      "19ff168f-33d3-4323-ac40-9185a58d4bc1": {
        "size": {
          "width": 150,
          "height": 150
        },
        "position": {
          "x": 1440,
          "y": 420
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": [],
        "dependson": [
          "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        ]
      },
      "fe77f2ab-993f-42eb-b002-d9e659e9622a": {
        "source": {
          "id": "354957ff-f5db-4adf-9db4-ba410fa526dc"
        },
        "target": {
          "id": "19ff168f-33d3-4323-ac40-9185a58d4bc1"
        }
      },
      "4faf1d12-aa67-4fa4-873d-d450b62683dd": {
        "source": {
          "id": "0cc90b59-a6f4-4d06-b1c6-723d939a0310"
        },
        "target": {
          "id": "bbea161c-a3b3-4e38-b121-2b5e3d277e21"
        },
        "z": 0
      },
      "740a7995-7171-4aa1-a64a-85ca31e1ebd8": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 450,
          "y": 120
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": []
      },
      "47ade2e2-a6f0-4886-a9ea-4a1b1c4b521e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 60,
          "y": 300
        },
        "z": 1,
        "embeds": [],
        "ismemberof": [
          "740a7995-7171-4aa1-a64a-85ca31e1ebd8"
        ],
        "isrelatedto": [
          "f87133aa-629a-4e89-91f5-7849278dfb3e",
          "2d10e566-e32b-475b-8ff0-ad97ba910a0d"
        ]
      },
      "8efd2344-15c6-42da-ae4b-c5ab04bc6328": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 570,
          "y": 120
        },
        "z": 2,
        "parent": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae",
        "embeds": [],
        "isrelatedto": [
          "740a7995-7171-4aa1-a64a-85ca31e1ebd8"
        ]
      },
      "57fcb469-d7de-49dd-b8fa-3e1cbaf16484": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 180,
          "y": 300
        },
        "z": 1,
        "embeds": [],
        "isconnectedto": [
          "19ff168f-33d3-4323-ac40-9185a58d4bc1"
        ],
        "isassociatedwith": [
          "47ade2e2-a6f0-4886-a9ea-4a1b1c4b521e"
        ],
        "dependson": [
          "41de699c-05c9-4dc6-839d-ca1e2866ba63",
          "7372bde0-3ec1-4e59-a5ed-d00331f81246",
          "9c4d1f2a-99b3-40a1-9597-ff01d4374873",
          "6b1df302-7694-4e74-8e69-7bde89b35309"
        ]
      }
    }
  },
  "Resources": {
    "MainVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a79e0ed5-5277-45ef-a0ed-23a7f2ea4bae"
        }
      }
    },
    "DirectorProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/dockerCaas/director/",
        "Roles": [
          "daasDirectorInstance"
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f87133aa-629a-4e89-91f5-7849278dfb3e"
        }
      }
    },
    "NodeProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/dockerCaas/node/",
        "Roles": [
          "daasNodeInstance"
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f87133aa-629a-4e89-91f5-7849278dfb3e"
        }
      }
    },
    "Director1": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "SubnetId": {
          "Ref": "DirectorsSubnet"
        },
        "KeyName": {
          "Ref": "KeyPair"
        },
        "PrivateIpAddress": "10.0.128.10",
        "InstanceType": {
          "Ref": "DirectorInstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "DirectorProfile"
        },
        "SecurityGroupIds": [
          {
            "Ref": "DirectorsSecurityGroup"
          }
        ],
        "ImageId": "ami-08111162",
        "Tags": [
          {
            "Key": "InstanceRole",
            "Value": "Director"
          },
          {
            "Key": "InstanceId",
            "Value": "D1"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum update -y\n",
                "yum install -y docker\n",
                "export AWS_AZ=",
                {
                  "Ref": "AvailabilityZone"
                },
                "\n",
                "export AWS_REGION=${AWS_AZ:0:-1}\n",
                "service docker start\n",
                "CMD_RUN=`docker run --rm progrium/consul cmd:run 10.0.128.10 -d -e GOMAXPROCS=2 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=Directors/1 --log-opt awslogs-region=$AWS_REGION`\n",
                "$CMD_RUN -ui-dir /ui\n",
                "docker run -d -p 4000:4000 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=SwarmManagers/1 --log-opt awslogs-region=$AWS_REGION swarm manage --host :4000 --replication --strategy binpack --advertise 10.0.128.10:4000 consul://10.0.128.10:8500\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7372bde0-3ec1-4e59-a5ed-d00331f81246"
        }
      },
      "DependsOn": [
        "MainVPC",
        "DirectorsSubnet",
        "Director1LogStream",
        "SwarmManager1LogStream",
        "DirectorProfile",
        "DirectorsInternetRoute",
        "DirectorsSecurityGroup"
      ]
    },
    "Director2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "SubnetId": {
          "Ref": "DirectorsSubnet"
        },
        "KeyName": {
          "Ref": "KeyPair"
        },
        "PrivateIpAddress": "10.0.128.11",
        "InstanceType": {
          "Ref": "DirectorInstanceType"
        },
        "SecurityGroupIds": [
          {
            "Ref": "DirectorsSecurityGroup"
          }
        ],
        "IamInstanceProfile": {
          "Ref": "DirectorProfile"
        },
        "ImageId": "ami-08111162",
        "Tags": [
          {
            "Key": "InstanceRole",
            "Value": "Director"
          },
          {
            "Key": "InstanceId",
            "Value": "D2"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum update -y\n",
                "yum install -y docker\n",
                "export AWS_AZ=",
                {
                  "Ref": "AvailabilityZone"
                },
                "\n",
                "export AWS_REGION=${AWS_AZ:0:-1}\n",
                "service docker start\n",
                "CMD_RUN=`docker run --rm progrium/consul cmd:run 10.0.128.11::10.0.128.10 -d -e GOMAXPROCS=2 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=Directors/2 --log-opt awslogs-region=$AWS_REGION`\n",
                "$CMD_RUN -ui-dir /ui\n",
                "docker run -d -p 4000:4000 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=SwarmManagers/2 --log-opt awslogs-region=$AWS_REGION swarm manage --host :4000 --replication --strategy binpack --advertise 10.0.128.11:4000 consul://10.0.128.11:8500\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "9c4d1f2a-99b3-40a1-9597-ff01d4374873"
        }
      },
      "DependsOn": [
        "MainVPC",
        "DirectorsSubnet",
        "Director2LogStream",
        "SwarmManager2LogStream",
        "DirectorProfile",
        "DirectorsInternetRoute",
        "DirectorsSecurityGroup",
        "Director1"
      ]
    },
    "Director3": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "SubnetId": {
          "Ref": "DirectorsSubnet"
        },
        "KeyName": {
          "Ref": "KeyPair"
        },
        "PrivateIpAddress": "10.0.128.12",
        "InstanceType": {
          "Ref": "DirectorInstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "DirectorProfile"
        },
        "SecurityGroupIds": [
          {
            "Ref": "DirectorsSecurityGroup"
          }
        ],
        "ImageId": "ami-08111162",
        "Tags": [
          {
            "Key": "InstanceRole",
            "Value": "Director"
          },
          {
            "Key": "InstanceId",
            "Value": "D3"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum update -y\n",
                "yum install -y docker\n",
                "export AWS_AZ=",
                {
                  "Ref": "AvailabilityZone"
                },
                "\n",
                "export AWS_REGION=${AWS_AZ:0:-1}\n",
                "service docker start\n",
                "CMD_RUN=`docker run --rm progrium/consul cmd:run 10.0.128.12::10.0.128.10 -d -e GOMAXPROCS=2 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=Directors/3 --log-opt awslogs-region=$AWS_REGION`\n",
                "$CMD_RUN -ui-dir /ui\n",
                "docker run -d -p 4000:4000 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "DirectorsLogGroup"
                },
                " --log-opt awslogs-stream=SwarmManagers/3 --log-opt awslogs-region=$AWS_REGION swarm manage --host :4000 --replication --strategy binpack --advertise 10.0.128.12:4000 consul://10.0.128.12:8500\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6b1df302-7694-4e74-8e69-7bde89b35309"
        }
      },
      "DependsOn": [
        "MainVPC",
        "DirectorsSubnet",
        "Director3LogStream",
        "SwarmManager3LogStream",
        "DirectorProfile",
        "DirectorsInternetRoute",
        "DirectorsSecurityGroup",
        "Director1"
      ]
    },
    "DirectorsSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Directors Security Group",
        "VpcId": {
          "Ref": "MainVPC"
        },
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22
          },
          {
            "IpProtocol": "-1",
            "SourceSecurityGroupId": {
              "Ref": "NodesSecurityGroup"
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "8efd2344-15c6-42da-ae4b-c5ab04bc6328"
        }
      }
    },
    "DirectorsSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {
          "Ref": "DirectorsSecurityGroup"
        },
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "DirectorsSecurityGroup"
        }
      },
      "DependsOn": "DirectorsSecurityGroup"
    },
    "NodesSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Nodes Security Group",
        "VpcId": {
          "Ref": "MainVPC"
        },
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ],
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "740a7995-7171-4aa1-a64a-85ca31e1ebd8"
        }
      }
    },
    "DirectorsSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "VpcId": {
          "Ref": "MainVPC"
        },
        "CidrBlock": "10.0.128.0/24",
        "MapPublicIpOnLaunch": true
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "bbea161c-a3b3-4e38-b121-2b5e3d277e21"
        }
      },
      "DependsOn": [
        "MainVPC"
      ]
    },
    "NodesSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "AvailabilityZone"
        },
        "VpcId": {
          "Ref": "MainVPC"
        },
        "CidrBlock": "10.0.0.0/17",
        "MapPublicIpOnLaunch": true
      },
      "DependsOn": [
        "MainVPC"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "19ff168f-33d3-4323-ac40-9185a58d4bc1"
        }
      }
    },
    "DirectorsLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f2687dbb-271f-4ad5-bb65-9bca35aeabd0"
        }
      }
    },
    "NodesLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2d10e566-e32b-475b-8ff0-ad97ba910a0d"
        }
      }
    },
    "Director1LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "Directors/1"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e9536e71-e732-45b1-bfbe-6de3cb45d38f"
        }
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ]
    },
    "Director2LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "Directors/2"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "87ee7a24-1cbc-41f3-b569-992f3d37e5df"
        }
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ]
    },
    "Director3LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "Directors/3"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6bc4af5d-0a21-45e3-ba91-d7bd7507236a"
        }
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ]
    },
    "SwarmManager1LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "SwarmManagers/1"
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "522b9b95-ecb1-4be0-b959-7d0d381c3f50"
        }
      }
    },
    "SwarmManager2LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "SwarmManagers/2"
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2f7eb117-ff94-451e-a866-2962568d5445"
        }
      }
    },
    "SwarmManager3LogStream": {
      "Type": "AWS::Logs::LogStream",
      "Properties": {
        "LogGroupName": {
          "Ref": "DirectorsLogGroup"
        },
        "LogStreamName": "SwarmManagers/3"
      },
      "DependsOn": [
        "DirectorsLogGroup"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "75b2464c-d8ef-48f7-8fe0-6aadd2981a3c"
        }
      }
    },
    "MainInternetGwy": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1b03182d-45fa-4b33-8c10-21729c42bdb8"
        }
      }
    },
    "MainInternetGwyAttch": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "MainInternetGwy"
        },
        "VpcId": {
          "Ref": "MainVPC"
        }
      },
      "DependsOn": [
        "MainInternetGwy",
        "MainVPC"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "41de699c-05c9-4dc6-839d-ca1e2866ba63"
        }
      }
    },
    "DirectorsRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "MainVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0cc90b59-a6f4-4d06-b1c6-723d939a0310"
        }
      },
      "DependsOn": [
        "MainVPC"
      ]
    },
    "DirectorsRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "DirectorsRouteTable"
        },
        "SubnetId": {
          "Ref": "DirectorsSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "4faf1d12-aa67-4fa4-873d-d450b62683dd"
        }
      }
    },
    "NodesRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "MainVPC"
        }
      },
      "DependsOn": [
        "MainVPC"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "354957ff-f5db-4adf-9db4-ba410fa526dc"
        }
      }
    },
    "NodesRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "NodesRouteTable"
        },
        "SubnetId": {
          "Ref": "NodesSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "fe77f2ab-993f-42eb-b002-d9e659e9622a"
        }
      }
    },
    "DirectorsInternetRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "MainInternetGwy"
        },
        "RouteTableId": {
          "Ref": "DirectorsRouteTable"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e086d890-4c12-4b25-90f9-3733667e60e3"
        }
      },
      "DependsOn": [
        "DirectorsRouteTable"
      ]
    },
    "NodesInternetRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "MainInternetGwy"
        },
        "RouteTableId": {
          "Ref": "NodesRouteTable"
        }
      },
      "DependsOn": [
        "NodesRouteTable"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "689ec45f-eaa7-45b9-b35e-7cf75c018d16"
        }
      }
    },
    "NodesLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "AssociatePublicIpAddress": true,
        "IamInstanceProfile": {
          "Ref": "NodeProfile"
        },
        "ImageId": "ami-08111162",
        "InstanceType": {
          "Ref": "NodeInstanceType"
        },
        "KeyName": {
          "Ref": "KeyPair"
        },
        "SecurityGroups": [
          {
            "Ref": "NodesSecurityGroup"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum -y update\n",
                "yum -y install docker\n",
                "export AWS_AZ=",
                {
                  "Ref": "AvailabilityZone"
                },
                "\n",
                "export AWS_REGION=${AWS_AZ:0:-1}\n",
                "export VPC_ADDRESS=$(hostname --ip-address)\n",
                "echo OPTIONS=\"\\$OPTIONS -H tcp://$VPC_ADDRESS:2375 -H unix:///var/run/docker.sock\" >> /etc/sysconfig/docker\n",
                "service docker start\n",
                "`docker run --rm progrium/consul cmd:run $VPC_ADDRESS::10.0.128.10::client -d -e GOMAXPROCS=2 --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "NodesLogGroup"
                },
                " --log-opt awslogs-stream=$VPC_ADDRESS/consul --log-opt awslogs-region=$AWS_REGION`\n",
                "docker run -d --log-driver=awslogs --log-opt awslogs-group=",
                {
                  "Ref": "NodesLogGroup"
                },
                " --log-opt awslogs-stream=$VPC_ADDRESS/node --log-opt awslogs-region=$AWS_REGION swarm join --advertise=$VPC_ADDRESS:2375 consul://$VPC_ADDRESS:8500\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "47ade2e2-a6f0-4886-a9ea-4a1b1c4b521e"
        }
      }
    },
    "NodesAutoscalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AvailabilityZones": [
          {
            "Ref": "AvailabilityZone"
          }
        ],
        "Cooldown": 30,
        "DesiredCapacity": {
          "Ref": "NodesMin"
        },
        "HealthCheckGracePeriod": 120,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "NodesLaunchConfiguration"
        },
        "LoadBalancerNames": [],
        "MaxSize": {
          "Ref": "NodesMax"
        },
        "MinSize": {
          "Ref": "NodesMin"
        },
        "VPCZoneIdentifier": [
          {
            "Ref": "NodesSubnet"
          }
        ]
      },
      "DependsOn": [
        "MainInternetGwyAttch",
        "Director1",
        "Director2",
        "Director3"
      ],
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "57fcb469-d7de-49dd-b8fa-3e1cbaf16484"
        }
      }
    },
    "NodesAutoscalingPolicy": {
      "Type" : "AWS::AutoScaling::ScalingPolicy",
      "Properties" : {
        "AdjustmentType" : "ChangeInCapacity",
        "AutoScalingGroupName" : {
          "Ref": "NodesAutoscalingGroup"
        },
        "Cooldown" : 30,
        "EstimatedInstanceWarmup" : 60,
        "PolicyType" : "SimpleScaling",
        "ScalingAdjustment" : 1
      }
    }
  },
  "Parameters": {
    "KeyPair": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description": "Key pair to add to the instances"
    },
    "AvailabilityZone": {
      "Type": "AWS::EC2::AvailabilityZone::Name",
      "Description": "Availability Zone"
    },
    "DirectorInstanceType": {
      "Type": "String",
      "Description": "EC2 instance type for the directors",
      "Default": "t2.micro",
      "AllowedValues": [
        "t2.micro"
      ]
    },
    "NodeInstanceType": {
      "Type": "String",
      "Description": "EC2 instance type for the nodes",
      "Default": "t2.micro",
      "AllowedValues": [
        "t2.micro"
      ]
    },
    "NodesMin": {
      "Type": "Number",
      "Description": "Minimum nodes in the cluster",
      "Default": 0,
      "MinValue": 0
    },
    "NodesMax": {
      "Type": "Number",
      "Description": "Maximum nodes in the cluster",
      "Default": 100,
      "MinValue": 1
    }
  }
}